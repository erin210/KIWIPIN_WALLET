<!DOCTYPE html>
<html lang="en" translate="no">

<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="google" content="notranslate" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="format-detection" content="telephone=no" />
<title>KIWI WALLET</title>
</script>
<link rel="icon" href="https://wallet-page-t.kiwipin.com//favicon.png">
<link rel="icon" href="https://wallet-page-t.kiwipin.com//favicon.ico">
<script src="https://wallet-page-t.kiwipin.com//assets/js/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://wallet-page-t.kiwipin.com//assets/css/reset.css">
<link rel="stylesheet" href="https://wallet-page-t.kiwipin.com//assets/css/bootstrap-grid.css">
<link rel="stylesheet" href="https://wallet-page-t.kiwipin.com//assets/css/select2.min.css" />
<link rel="stylesheet" href="https://wallet-page-t.kiwipin.com//assets/css/wallet.css">
<script src="https://wallet-page-t.kiwipin.com//assets/js/translate.js"></script>
<script src="https://wallet-page-t.kiwipin.com//assets/js/loadingoverlay.min.js"></script>
<script>
    function initFunction(jsonObj) {
        renderInfo(jsonObj);
    }
</script>
</head>

<body class="walletLogin">
    <div id="apiWallet">
        <div class="container">
            <aside>
                <div class="logo">
                    <img src="https://wallet-page-t.kiwipin.com//assets/img/logo3.svg" alt="">
                </div>
                <div class="tabs">
                    <div class="tab tab1 active">
                        <a href="login">
                            <i class="oo1"></i>
                            <i class="oo2"></i>
                            <h3><span class="WL_TAB_FORGET_PW">重設密碼</span></h3>
                        </a>
                        <div class="bg_im"><img src="https://wallet-page-t.kiwipin.com//assets/img/bg_im.svg" alt=""></div>
                    </div>
                </div>
            </aside>

            <div class="tab_container">
                <div id="langSelect" class="languageBox">
                    <img src="https://wallet-page-t.kiwipin.com//assets/img/icon_language.svg" alt="" srcset="">
                    <span class="lang_text">語言</span>
                    <ul id="langListItem" class="langListItem">
                        <ul id="landList">
                            <li class="active">
                                简中
                            </li>
                            <li>
                                English
                            </li>
                            <li>
                                日本語
                            </li>
                            <li>
                                한국어
                            </li>
                            <li>
                                Tiếng Việt
                            </li>
                        </ul>
                    </ul>
                </div>
                <div class="logo">
                    <img src="https://wallet-page-t.kiwipin.com//assets/img/logo1.svg" alt="">
                </div>
                <!-- tab1 op-->
                <div id="tab1" class="tab_content">
                    <form role="form" id="form" action="" method="post" target="_self" class="form-payment"
                        onsubmit="return check_submit();">
                        <div class="form_list reg">
                            <h4 class="WL_TAB_FORGET_PW">重設密碼</h4>
                            <p class="WL_FORGET_PW_REMIND">請輸入已註冊的信箱，系統會發送驗證碼。再請輸入正確的驗證碼，以便重設密碼</p>
                            <ul>
                                <li class="check_code email">
                                    <span class="WL_U_EMAIL_TITLE">會員信箱</span>
                                    <div id="send_code" class="send_code">
                                        <input type="text" name="U_EMAIL" id="U_EMAIL" class="WL_U_EMAIL_HINT" placeholder="請輸入Email">
                                        <a id="SEND_VERIFY_CODE" href="javascript:void(0)" onclick="return send_VERIFY_CODE();"><i class="WL_SEND_VERIFY_CODE_BTN">發送驗證碼</i><i class="WL_SEND_VERIFY_CODE_ING" style="display: none;">發送中...</i><i class="WL_SEND_VERIFY_CODE_RESEND" style="display: none;">重新發送</i></a>
                                        <div id="countdown" class="countdown send_code" style="display: none;"><a><img
                                                    src="https://wallet-page-t.kiwipin.com//assets/img/icon_check_ok.svg" alt=""> <i class="WL_SEND_VERIFY_CODE_COUNT">已發送</i>( <span
                                                    id="countdown_second">0</span>)</a></div>
                                    </div>
                                    <div class="wrong_msg email_msg" style="display:none"><img
                                            src="https://wallet-page-t.kiwipin.com//assets/img/icon_error.svg" alt=""><small class="email_msg_text WL_U_EMAIL_MSG_EMPTY">空白警告</small><small class="email_msg_text WL_MSG_ERROR">格式錯誤警告</small></div>
                                </li>
                                <li class="check_code">
                                    <span class="WL_U_VERIFY_CODE_TITLE">驗證碼</span>
                                    <input type="text" name="U_VERIFY_CODE" id="U_VERIFY_CODE" class="WL_U_VERIFY_CODE_HINT" placeholder="請輸入驗證碼"
                                        inputmode="numeric">
                                    <div class="wrong_msg verify_code_msg" style="display:none"><img
                                            src="https://wallet-page-t.kiwipin.com//assets/img/icon_error.svg" alt=""><small
                                            class="verify_code_msg_text WL_U_VERIFY_CODE_MSG_EMPTY">請填寫驗證碼</small></div>
                                </li>
                            </ul>
                            <div class="form_bt">
                                <p><a href="login" class="tab_bt WL_BACK_LOGIN" rel="tab1">返回登入</a></p>
                                <a id="confirm" href="javascript:void(0)" onclick="return check_submit();"
                                    class="btn btn_blue WL_TAB_FORGET_PW">重設密碼</a>
                            </div>
                        </div>
                        <input id="U_LANGUAGE" type="hidden" name="U_LANGUAGE" value="">
                    </form>
                </div>
                <!-- tab1 ed-->
            </div>
        </div>
    </div>
    <!--popup_1-->
    <div id="popup" class="popup" style="display: none;">
        <div class="container">
            <div class="popup_left"></div>
            <div class="popup_wrapper">
                <div class="content">
                    <img class="icon popup_icon popup_icon_success" src="https://wallet-page-t.kiwipin.com//assets/img/icon_success.svg" alt="">
                    <img class="icon popup_icon popup_icon_error" src="https://wallet-page-t.kiwipin.com//assets/img/icon_error.svg" alt="">
                    <h1 id="popup_title" class="title">跳窗標題</h1>
                    <h1 id="popup_notice" class="notice">跳窗資訊內文</h1>
                </div>
                <a id="popup_a" href="javascript:void(0)" onclick="$('#popup').hide();"
                    class="btn confirm btn_pop_close WL_CONFIRM">確認</a>
            </div>
        </div>
    </div>

    <script>
        // $(function () {
        //     $('base').attr('href', apiUrl);
        // });
       $("#U_LANGUAGE").val(thisLang);
    //    console.log(thisLang);
       

        function renderInfo(json) {

            //popup-密碼發送通知
            if (json.MESSAGE_TYPE !== null && json.MESSAGE_TYPE !== undefined) {
                $(".popup_icon").hide();
                if (json.MESSAGE_TYPE == "S") {
                    $(".popup_icon_success").show();
                    $("#popup_title").attr('class','title WL_FORGET_PW_SUBMIT_TITLE_S');
                    $("#popup_a").attr("href", "login");
                } else {
                    $(".popup_icon_error").show();
                    $("#popup_title").attr('class','title WL_VERIFY_TITLE_F');
                    $("#popup_a").attr("href", "javascript:void(0)");
                   
                }
                 //解構parseSystemMessage
                const { id: RESULT_ID, msg: RESULT_MSG } = parseSystemMessage(json.SYSTEM_MESSAGE) || {};
                // console.log('systemMSG', systemMSG);
                $("#popup_notice").html(`<b class="${RESULT_ID}"></b>${RESULT_MSG}`);
                $("#popup").show();
            }

            

            //找出json所有key
            Object.keys(json).forEach(function (k) {
                var eleName = '#' + k;
                // console.log(eleName + ' - ' + json[k]);
                if ($(eleName).length <= 0) {
                    appendElement_Input('#form', k, json[k]);
                } else {
                    $(eleName).val(json[k]);
                }
            });
            
            
            initTranslation(json)//翻譯
            $("#U_LANGUAGE").val(thisLang);

        }

        //整理 SYSTEM_MESSAGE-ID+系統字
            function parseSystemMessage(systemMessage) {
                if (!systemMessage) return null;

                // 解析 [%ID%] 後面的字串
                const matchId = systemMessage.match(/\[%(.+?)%\](.*)/);

                if (!matchId) return null;

                const RESULT_ID = matchId[1];
                const RESULT_MSG = (matchId[2] || "").trim();

                return { id: RESULT_ID, msg: RESULT_MSG };
            }

        //印input hidden
            function appendElement_Input(ele, name, value) {
                var textHtml = '<input type="hidden" name="' + name + '"';
                textHtml += ' value="' + value + '"';
                textHtml += '/>';
                $(ele).append(textHtml);
            }
        //密碼眼睛
        let pageBaseUrl = '';
        $('.togglePassword').on('click', function () {
            const passwordField = $(this).siblings('input');
            const isPasswordVisible = passwordField.attr('type') === 'text';
            passwordField.attr('type', isPasswordVisible ? 'password' : 'text');

            const newIconSrc = isPasswordVisible ? pageBaseUrl + 'https://wallet-page-t.kiwipin.com//assets/img/icon_eye_close.svg' : pageBaseUrl + 'https://wallet-page-t.kiwipin.com//assets/img/icon_eye_open.svg';
            $(this).attr('src', newIconSrc);
        });

        

        function preventScroll(e) {
            e.preventDefault(); // 禁止滾動
        }

        //發送驗證碼
        function send_VERIFY_CODE() {
             
            // 檢查是否有填寫 #U_EMAIL
            if (!validateEmptyField('#U_EMAIL', '.email_msg_text', ".WL_U_EMAIL_MSG_EMPTY")) {
                return;
            }

            // 檢查格式是否正確
            if (!validateEmailFormat('#U_EMAIL', '.email_msg_text','.WL_MSG_ERROR')) {
                return;
            }

            const TOKEN = "";
            const url = "https://wallet.kiwipin.com/sendVerifyCode";
            // const url = "http://localhost:3001/sendVerifyCode";//本地測試用

            let headers = {
                "Content-Type": "application/json",
                "Accept": "application/json"
            };

            // 如果有需要帶 Token
            if (TOKEN) {
                headers["Authorization"] = `Bearer ${TOKEN}`;
            }

            // console.log($('#SEND_VERIFY_CODE').data('lang'));

            // API 文件規定的必填參數
            let body = {
                "TYPE": "FORGET_PASSWORD",
                "VERIFY_TYPE": "FORGET_PASSWORD",
                "EMail": $('#U_EMAIL').val(),
                "LANGUAGE": $("#U_LANGUAGE").val()
            };

            //鎖住畫面
            $.LoadingOverlay("show", {
                image: "",  // 不用預設圖片
                custom: $("<div>", { class: "custom-spinner" })[0],
                background: "rgba(255,255,255,0.8)"
            });

            fetch(url, {
                method: "POST",
                headers: headers,
                body: JSON.stringify(body) // 一定要轉字串
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP Error " + response.status);
                }
                return response.json();
            })
            .then(function (json) {
                // console.log(json);
                
                // console.log(json.StringID.en_US.VERIFY_TITLE_S);
                
                // console.log("收到 JSON:", json);
                $(".popup_icon").hide();

                if (json.SendResult === "Success") {
                    $(".popup_icon_success").show();
                    $("#popup_title").text(json.SendResult_Title);
                    $("#popup_notice").text(json.SendResult_Message);

                    $('#U_EMAIL').attr('readonly', true);
                } else {
                    $(".popup_icon_error").show();
                    $("#popup_title").text(json.SendResult_Title);
                    $("#popup_notice").text(json.SendResult_Message);
                }
                // 關閉 loading
                $.LoadingOverlay("hide");

                $("#popup").show();

                // 控制按鈕與倒數
                $('#SEND_VERIFY_CODE').attr('disabled', true).hide();
                $("#countdown").show();
                $('.WL_SEND_VERIFY_CODE_BTN').hide();
                $('.WL_SEND_VERIFY_CODE_ING').fadeIn(100);

                timer_countdown(60, "countdown_second", "timer_Finished");
                

            })
            .catch(err => {
                
                console.error("API 錯誤:", err);// 關閉 loading
                $(".popup_icon").hide();
                $(".popup_icon_error").show();
                $("#popup_title")
                    .attr("class", "")
                    .addClass("title WL_VERIFY_TITLE_F");
                $("#popup_notice").html("API錯誤資訊");
                $.LoadingOverlay("hide");
                $("#popup").show();
            });
            
            $('#U_VERIFY_CODE').attr('disabled', false);
        }

        // 監聽驗證 op====================
        // 驗證函數 - 是否空白
        function validateEmptyField(selector, messageSelector, messageClass) {
            const value = $(selector).val();
            if (value === "") {
                $(messageSelector).hide();
                $(messageSelector + messageClass).show().parent().show(); // 顯示父層 .password_msg
                $(selector).addClass('input_error');
                return false;
            } else {
                $(messageSelector).parent().hide();
                $(selector).removeClass('input_error');
                return true;
            }
        }
        
        // 驗證函數 - 是否符合格式 (Email)
        function validateEmailFormat(selector, messageSelector, messageClass) {
            const value = $(selector).val();
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Email 正則表達式
            if (!emailPattern.test(value)) {
                $(messageSelector).hide();
                $(messageSelector + messageClass).show().parent().show();
                $(selector).addClass('input_error');
                return false;
            } else {
                $(messageSelector).parent().hide();
                $(selector).removeClass('input_error');
                return true;
            }
        }
            // 驗證函數 - checkbox是否打勾
                // function validateCheckbox(selector, messageSelector, message) {
                //     const value = $(selector);
                //     if (!value.is(':checked')) {
                //         $(messageSelector).text(message).parent().show();
                //         $(selector).addClass('input_error');
                //         return false;
                //     } else {
                //         $(messageSelector).parent().hide();
                //         $(selector).removeClass('input_error');
                //         return true;
                //     }
                // }

        // 即時監聽驗證
        // 會員帳號
        $('#U_EMAIL').on('input', function () {
            if (validateEmptyField('#U_EMAIL', '.email_msg_text', ".WL_U_EMAIL_MSG_EMPTY"))
                validateEmailFormat('#U_EMAIL', '.email_msg_text', '.WL_MSG_ERROR');
        });
        // 監聽驗證 ed====================

        // 提交的驗證
        function check_ALL() {
            let isValid = true;
            //email
            if (!validateEmptyField('#U_EMAIL', '.email_msg_text', ".WL_U_EMAIL_MSG_EMPTY")) isValid = false;
            if (isValid && !validateEmailFormat('#U_EMAIL', '.email_msg_text', '.WL_MSG_ERROR')) isValid = false;
            //驗證碼
            if (!validateEmptyField('#U_VERIFY_CODE', '.verify_code_msg_text', ".WL_U_VERIFY_CODE_MSG_EMPTY")) isValid = false;
            // if (!validateCheckbox('#agree', '.agree_msg_text', "請勾選同意")) isValid = false;

            return isValid;
        }

        function check_submit() {
            if (!check_ALL()) {
                return false;
            }
            //鎖住畫面
            // $.LoadingOverlay("show", {
            //     image: "",  // 不用預設圖片
            //     custom: $("<div>", { class: "custom-spinner" })[0],
            //     background: "rgba(255,255,255,0.8)"
            // });

            // 阻止表單的預設提交行為// 阻止預設表單提交
            // if (e) e.preventDefault(); 

            document.getElementById('form').submit();
            
            //return true;
        }


        function timer_countdown(countdownTime, eleID, callFunction) {
            let temp_eleID = "#" + eleID;

            // 更新顯示的倒數秒數
            if (eleID && $(temp_eleID).length) {
                $(temp_eleID).text(countdownTime + "s");
            }

            countdownTime--;  // 倒數計時減少 1 秒

            // 檢查是否還有剩餘時間
            if (countdownTime >= 0) {
                setTimeout(function () {
                    timer_countdown(countdownTime, eleID, callFunction);
                }, 1000);  // 每秒更新一次
            } else {
                // 倒數結束時執行指定的回呼函數
                if (callFunction !== undefined) {
                    let functionName = callFunction.split('(')[0];
                    let params = null;

                    // 檢查是否有參數傳入
                    if (callFunction.split('(')[1] !== undefined) {
                        params = callFunction.split('(')[1].split(')')[0];
                        params = params.replace(/^'|'$/g, '').replace(/^\"|\"$/g, '');
                        console.log(params);
                    }

                    // 執行回呼函數
                    window[functionName](params);
                }
            }
        }


        function timer_Finished() {
            $("#countdown").hide();
            $("#SEND_VERIFY_CODE").show();
            $('.WL_SEND_VERIFY_CODE_ING').hide();
            $('.WL_SEND_VERIFY_CODE_RESEND').fadeIn(100);
            $('#U_EMAIL').attr('disabled', false);
        }
    </script>

    <script>
        

    

    </script>
</body>

</html>